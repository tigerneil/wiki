<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<title data-react-helmet="true">testing | Gear documentation portal</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://wiki.gear-tech.io//developing-contracts/testing"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="testing | Gear documentation portal"><meta data-react-helmet="true" name="description" content="Smart contract testing"><meta data-react-helmet="true" property="og:description" content="Smart contract testing"><link data-react-helmet="true" rel="icon" href="/img/favicon-32x32.png"><link data-react-helmet="true" rel="canonical" href="https://wiki.gear-tech.io//developing-contracts/testing"><link data-react-helmet="true" rel="alternate" href="https://wiki.gear-tech.io//developing-contracts/testing" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://wiki.gear-tech.io//zh-cn/developing-contracts/testing" hreflang="zh-cn"><link data-react-helmet="true" rel="alternate" href="https://wiki.gear-tech.io//developing-contracts/testing" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.fb4df1ba.css">
<link rel="preload" href="/assets/js/runtime~main.104e92f9.js" as="script">
<link rel="preload" href="/assets/js/main.01f51f45.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-black.svg" alt="Gear documentation portal" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo-white.svg" alt="Gear documentation portal" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Gear Wiki</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/gear-tech/wiki" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_dNtB"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/developing-contracts/testing" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">English</a></li><li><a href="/zh-cn/developing-contracts/testing" target="_self" rel="noopener noreferrer" class="dropdown__link">ÁÆÄ‰Ωì‰∏≠Êñá</a></li></ul></div><div class="toggle_Pssr toggle_TdHA toggleChecked_cnQY toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">üåú</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">üåû</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" checked="" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Welcome!</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/gear/glossary">Intro to Gear</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/ecosystem/polkadot">Ecosystem</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/getting-started-in-5-minutes">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/idea/idea-overview">Gear IDEA</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/node/setting-up">Gear Node</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/developing-contracts/cargo-program">Developing Smart Contracts</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/developing-contracts/cargo-program">Cargo-program Utility</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/developing-contracts/gear-program">Program State</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/developing-contracts/messaging">Message Format</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/developing-contracts/testing">Program testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/developing-contracts/deploy">Upload Program</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/developing-contracts/send-a-transaction">Send a Message</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" tabindex="0" href="/developing-contracts/examples/prerequisites">Examples</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/api/connect">API for interacting with node</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/general/web3">General topics</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>testing</h1></header><h2 class="anchor anchorWithStickyNavbar_mojV" id="smart-contract-testing">Smart contract testing<a class="hash-link" href="#smart-contract-testing" title="Direct link to heading">‚Äã</a></h2><p>Gear lib <a href="https://github.com/gear-tech/gear/tree/master/gtest" target="_blank" rel="noopener noreferrer"><code>gtest</code></a> is the recommended option for the smart contracts logic testing. This article describes how to test smart contracts using <code>gtest</code>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="basics">Basics<a class="hash-link" href="#basics" title="Direct link to heading">‚Äã</a></h3><p>Gear uses the standard for Rust programs testing mechanism - test build mode from <code>cargo</code>.</p><p>In accordance to basic concepts and testing methods described in <a href="https://doc.rust-lang.org/book/ch11-00-testing.html" target="_blank" rel="noopener noreferrer">Rustbook</a>, tests can be organized in two main categories: <strong>unit tests</strong> and <strong>integration tests</strong>.</p><p>The <strong>unit tests</strong> enable testing of each unit of code in isolation from the rest of the code. It helps to quickly find where the code works as expected and where not. The unit tests should be placed in the <code>src</code> directory in each file with the code that they test.</p><p>Even when units of code work correctly, it is important to test if several parts of the library work together correctly as well. For <strong>integration tests</strong>, a separate tests directory is required at the top level of your project directory, next to <code>src</code>. You can make as many test files in this directory as you need, Cargo will compile each of the files as an individual crate.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="building-smart-contract-in-test-mode">Building smart contract in test mode<a class="hash-link" href="#building-smart-contract-in-test-mode" title="Direct link to heading">‚Äã</a></h3><p>First of all, make sure you have a compiled <code>WASM</code> file of the program you want to test. You can refer to <a href="/getting-started-in-5-minutes">Getting started</a> for additional details.</p><ol><li><p>Usually the following mandatory parameters must be used for regular compilation of Gear smart contracts:</p><ul><li><code>RUSTFLAGS=&quot;-C link-args=--import-memory&quot;</code></li><li><code>--target=wasm32-unknown-unknown</code></li><li><code>nightly</code> —Åompiler</li></ul><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">cd ~/gear/contracts/first-gear-app/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RUSTFLAGS=&quot;-C link-args=--import-memory&quot; cargo +nightly build --release --target=wasm32-unknown-unknown</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>For test running  they should <strong>not be used</strong>, instead the following conditions are <strong>required</strong>:</p><ul><li><code>--target</code> is not <code>wasm32-unknown-unknown</code>. It is recommended to build for the architecture of your device (you don&#x27;t need to specify any flags at all).</li><li><code>nightly</code> compiler - required if your contract uses unstable Rust features - the compiler will ask you to enable <code>nightly</code> if necessary. Only if you are writing the tests as unit/integration tests, rather than providing a separate library containing only the tests.</li></ul><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">cargo test</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>If you use <code>cargo</code> config files, then keep in mind that <code>[build]</code> parameters are applied both to <code>cargo build</code> and <code>cargo test</code> <a href="https://github.com/rust-lang/cargo/issues/6784" target="_blank" rel="noopener noreferrer">Github Issue</a>. For example - </p><div class="codeBlockContainer_I0IT language-toml theme-code-block"><div class="codeBlockContent_wNvx toml"><pre tabindex="0" class="prism-code language-toml codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># .cargo/config.toml</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[build]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">target = &quot;wasm32-unknown-unknown&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[target.wasm32-unknown-unknown]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">rustflags = [&quot;-C&quot;, &quot;link-args=--import-memory&quot;]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In this case, you have to choose the most convenient option for you:</p><ul><li><p>(Recommended) Remove build target <code>target=wasm32-unknown-unknown</code> from <code>config.toml</code>, which means that you have to</p><ul><li>Build the contract with: <code>cargo +nightly build --target wasm32-unknown-unknown</code></li><li>Run test as: <code>cargo test</code> (optionally: <code>cargo +nightly test</code>)</li></ul></li><li><p>Keep target in the configuration file, in this case:</p><ul><li>Build the contract with: <code>cargo +nightly build</code></li><li>Run test as: <code>cargo test --target any_not_wasm32_unknown_unknown_target</code></li></ul></li></ul></li><li><p>Every supported by Rust target is available from this command:
<code>rustc --print target-list</code></p></li></ol><p>How to find out your system target is described <a href="https://stackoverflow.com/questions/52996949/how-can-i-find-the-current-rust-compilers-default-llvm-target-triple?rq=1" target="_blank" rel="noopener noreferrer">here</a>.</p><p>So the most universal way to run test will be:</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">cargo test --target &quot;$(rustc -vV | sed -n &#x27;s|host: ||p&#x27;)&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p><code>sed</code> tool isn‚Äôt installed by default for Windows</p></div></div><p>For details on cargo configuration files, see <a href="https://doc.rust-lang.org/cargo/reference/config.html" target="_blank" rel="noopener noreferrer">Cargobook</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="import-gtest-lib">Import <code>gtest</code> lib<a class="hash-link" href="#import-gtest-lib" title="Direct link to heading">‚Äã</a></h3><p>In order to use the <code>gtest</code> library, it must be imported into your <code>Cargo.toml</code> file in the <code>[dev-dependencies]</code> block in order to fetch and compile it for tests only</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">[package]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">name = &quot;first-gear-app&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">version = &quot;0.1.0&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">authors = [&quot;Your Name&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">edition = &quot;2021&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">license = &quot;GPL-3.0&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[lib]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">crate-type = [&quot;cdylib&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[dependencies]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">gstd = { git = &quot;https://github.com/gear-tech/gear.git&quot;, features = [&quot;debug&quot;] }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[dev-dependencies]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">gtest = { git = &quot;https://github.com/gear-tech/gear.git&quot; }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[profile.release]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">lto = true</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">opt-level = &#x27;s&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="possible-issues">Possible issues<a class="hash-link" href="#possible-issues" title="Direct link to heading">‚Äã</a></h3><p>When writing tests as integration tests, it is not possible to import public structures from within the program itself, because gear contracts must have <code>crate-type=[&quot;cdylib&quot;]</code> struct and nothing can be imported from them.</p><p>Solution options:</p><ul><li>(Recommended) Create a sub-crate library with IO structures and import it into <code>Cargo.toml</code>. In this case, structures will be available everywhere.</li><li>Redefine the same structures in the test file (copy-paste), because with codec they will produce the same bytes.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="gtest-capabilities"><code>gtest</code> capabilities<a class="hash-link" href="#gtest-capabilities" title="Direct link to heading">‚Äã</a></h2><p>The example provided for <a href="/developing-contracts/examples/ping">PING-PONG</a>  program.</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use gtest::{Log, Program, System};</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#[test]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">fn basics() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Initialization of the common environment for running smart contacts.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // This emulates node&#x27;s and chain behavior.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // By default, sets:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // - current block equals 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // - current timestamp equals UNIX timestamp of your system.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // - minimal message id equal 0x010000..</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // - minimal program id equal 0x010000..</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let sys = System::new();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // You may control time in the system by spending blocks.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // It adds the amount of blocks passed as argument to the current block of the system.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Same for the timestamp. Note, that for now 1 block in Gear network is 1 sec duration.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sys.spend_blocks(150);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Initialization of styled `env_logger` to print logs (only from `gwasm` by default) into stdout.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // To specify printed logs, set the env variable `RUST_LOG`:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // `RUST_LOG=&quot;target_1=logging_level,target_2=logging_level&quot; cargo test`</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Gear smart contracts use `gwasm` target with `debug` logging level</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sys.init_logger();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Initialization of program structure from file.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Takes as arguments reference to the related `System` and the path to wasm binary relatively </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // the root of the crate where the test was written.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Sets free program id from the related `System` to this program. For this case it equals 0x010000..</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Next program initialized without id specification will have id 0x020000.. and so on.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let ping_pong = Program::from_file(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &amp;sys,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;./target/wasm32-unknown-unknown/release/demo_ping.wasm&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // We can check the id of the program by calling `id()` function.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // It returns `ProgramId` type value.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let ping_pong_id = ping_pong.id();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // There is also a `from_file_with_id` constructor to manually specify the id of the program.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Every place in this lib, where you need to specify some ids,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // it requires generic type `ID`, which implements `Into&lt;ProgramIdWrapper&gt;`.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // `ProgramIdWrapper` may be built from:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // - u64;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // - [u8; 32];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // - String;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // - &amp;str;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // - ProgramId (from `gear_core` one&#x27;s, not from `gstd`).</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // String implementation means the input as hex (with or without &quot;0x&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Numeric</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let _ = Program::from_file_with_id(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &amp;sys,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        105,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;./target/wasm32-unknown-unknown/release/demo_ping.wasm&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Hex with &quot;0x&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let _ = Program::from_file_with_id(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &amp;sys,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;0xe659a7a1628cdd93febc04a4e0646ea20e9f5f0ce097d9a05290d4a9e054df4e&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;./target/wasm32-unknown-unknown/release/demo_ping.wasm&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Hex without &quot;0x&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let _ = Program::from_file_with_id(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &amp;sys,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;e659a7a1628cdd93febc04a4e0646ea20e9f5f0ce097d9a05290d4a9e054df5e&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;./target/wasm32-unknown-unknown/release/demo_ping.wasm&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Array [u8; 32] (e.g. filled with 5)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let _ = Program::from_file_with_id(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &amp;sys,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        [5; 32],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;./target/wasm32-unknown-unknown/release/demo_ping.wasm&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // If you initialize program not in this scope, in cycle, in other conditions,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // where you didn&#x27;t save the structure, you may get the object from the system by id.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let _ = sys.get_program(105);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // To send message to the program need to call one of two program&#x27;s functions:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // `send()` or `send_bytes()`.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Both of the methods require sender id as the first argument and the payload as second.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // The difference between them is pretty simple and similar to `gstd` functions</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // `msg::send()` and `msg::send_bytes()`.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // The first one requires payload to be CODEC Encodable, while the second requires payload</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // implement `AsRef&lt;[u8]&gt;`, that means to be able to represent as bytes.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // `send()` uses `send_bytes()` under the hood with bytes from payload.encode().</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // First message to the initialized program structure is always the init message.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let res = ping_pong.send_bytes(100001, &quot;INIT MESSAGE&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Any sending functions in the lib returns `RunResult` structure.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // It contains the final result of the processing message and others,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // which were created during the execution.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // It has 4 main functions.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Returns the reference to the Vec produced to users messages.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // You may assert them as you wish, iterating through them.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    assert!(res.log().is_empty());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Returns bool which shows that there was panic during the execution</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // of the main message.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    assert!(!res.main_failed());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Returns bool which shows that there was panic during the execution</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // of the created messages during the main execution.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Equals false if no others were called.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    assert!(!res.others_failed());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Returns bool which shows that logs contains a given log.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Syntax sugar around `res.log().iter().any(|v| v == arg)`.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    assert!(!res.contains(&amp;Log::builder()));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // To build a log for assertion you need to use `Log` structure with it&#x27;s builders.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // All fields here are optional.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Assertion with Logs from core are made on the Some(..) fields</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // You will run into panic if you try to set the already specified field.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Constructor for success log.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let _ = Log::builder();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Constructor for error reply log.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Note that error reply never contains payload.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // And it&#x27;s exit code equals 1, instead of 0 for success replies.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let _ = Log::error_builder();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Let‚Äôs send a new message after the program has been initialized.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let res = ping_pong.send_bytes(100001, &quot;PING&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Other fields are set optionally by `dest()`, `source()`, `payload()`, `payload_bytes()`.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // The logic for `payload()` and `payload_bytes()` is the same as for `send()` and `send_bytes()`.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // First requires an encodable struct. The second requires bytes.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let log = Log::builder()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .source(ping_pong_id)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .dest(100001)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .payload_bytes(&quot;PONG&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    assert!(res.contains(&amp;log));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let wrong_log = Log::builder().source(100001);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    assert!(!res.contains(&amp;wrong_log));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Log also has `From` implementations from (ID, T) and from (ID, ID, T),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // where ID: Into&lt;ProgramIdWrapper&gt;, T: AsRef&lt;[u8]&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let x = Log::builder().dest(5).payload_bytes(&quot;A&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let x_from: Log = (5, &quot;A&quot;).into();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    assert_eq!(x, x_from);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let y = Log::builder().dest(5).source(15).payload_bytes(&quot;A&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let y_from: Log = (15, 5, &quot;A&quot;).into();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    assert_eq!(y, y_from);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    assert!(!res.contains(&amp;(ping_pong_id, ping_pong_id, &quot;PONG&quot;)));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    assert!(res.contains(&amp;(1, 100001, &quot;PONG&quot;)));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/gear-tech/wiki/edit/master/docs/developing-contracts/testing.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/developing-contracts/messaging"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Message Format</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/developing-contracts/deploy"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Upload Program</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#smart-contract-testing" class="table-of-contents__link toc-highlight">Smart contract testing</a><ul><li><a href="#basics" class="table-of-contents__link toc-highlight">Basics</a></li><li><a href="#building-smart-contract-in-test-mode" class="table-of-contents__link toc-highlight">Building smart contract in test mode</a></li><li><a href="#import-gtest-lib" class="table-of-contents__link toc-highlight">Import <code>gtest</code> lib</a></li><li><a href="#possible-issues" class="table-of-contents__link toc-highlight">Possible issues</a></li></ul></li><li><a href="#gtest-capabilities" class="table-of-contents__link toc-highlight"><code>gtest</code> capabilities</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.104e92f9.js"></script>
<script src="/assets/js/main.01f51f45.js"></script>
</body>
</html>